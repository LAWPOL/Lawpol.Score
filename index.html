<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบผลคะแนนสอบ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://img5.pic.in.th/file/secure-sv1/Logo463bb4b450154ca8.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Itim&amp;display=swap" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; font-family: 'Itim', sans-serif; }
        .result-card { display: none; margin-top: 20px; }
        .score-section { background-color: #841111; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-title { border-bottom: 2px solid #0043a7; padding-bottom: 10px; margin-bottom: 15px; color: #0d6efd; font-weight: bold; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="d-flex justify-content-center align-items-center mb-0">
                        <img src="https://i.postimg.cc/k5wc3XMY/phe-mh-wre-xng.png" alt="ตราโรงเรียน" class="mb-4" style="height: 6rem; width: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                    </div>
            <div class="card shadow-sm">
                <div class="card-body text-center p-4" style="background-color: #841111;">
                    <h2 class="mb-4" style="color: #f8f9fa; font-size: 20px;">ตรวจสอบผลคะแนนสอบ</h2>
                    <form id="searchForm" onsubmit="searchData(event)">
                        <div class="input-group mb-3">
                            <input type="text" id="idCard" class="form-control form-control-lg" placeholder="กรอกเลขประจำตัวประชาชน 13 หลัก" required maxlength="13">
                            <button class="btn btn-primary btn-lg" style="background-color: #0043a7;" type="submit" id="searchBtn">ตรวจสอบคะแนน</button>
                        </div>
                    </form>
                    <div id="loading" class="text-primary mt-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status"></div> กำลังค้นหาข้อมูล...
                    </div>
                    <div id="errorMsg" class="text-danger mt-3" style="display: none;">ไม่พบข้อมูล รุณาตรวจสอบเลขบัตรประชาชนอีกครั้ง</div>
                </div>
            </div>

            <div id="resultArea" class="result-card">
                
                <div class="score-section border-top border-primary border-4">
                    <h5 class="fw-bold">ข้อมูลผู้เข้าสอบ</h5>
                    <div class="row mt-3">
                        <div class="col-sm-6"><p><strong>เลขที่เข้าสอบ:</strong> <span id="res-exam-no"></span></p></div>
                        <div class="col-sm-6"><p><strong>ชื่อ-สกุล:</strong> <span id="res-name"></span></p></div>
                    </div>
                </div>

                <div class="score-section">
                    <h5 class="section-title">ตอนที่ 1 วิชาสามัญ (เต็ม 100 คะแนน)</h5>
                    <table class="table table-sm">
                        <tr><td>คณิตศาสตร์</td><td class="text-end" id="res-math"></td></tr>
                        <tr><td>วิทยาศาสตร์</td><td class="text-end" id="res-science"></td></tr>
                        <tr><td>ภาษาอังกฤษ</td><td class="text-end" id="res-english"></td></tr>
                        <tr><td>ภาษาไทย</td><td class="text-end" id="res-thai"></td></tr>
                        <tr><td>สังคมศึกษา</td><td class="text-end" id="res-social"></td></tr>
                        <tr class="table-primary fw-bold"><td>รวมวิชาสามัญ</td><td class="text-end" id="res-total-core"></td></tr>
                    </table>
                </div>

                <div class="score-section">
                    <h5 class="section-title">ตอนที่ 2 ความถนัดทางนิติศาสตร์ - รัฐศาสตร์ (เต็ม 80 คะแนน)</h5>
                    <table class="table table-sm">
                        <tr><td>พื้นฐานนิติศาสตร์</td><td class="text-end" id="res-law"></td></tr>
                        <tr><td>พื้นฐานรัฐศาสตร์</td><td class="text-end" id="res-politics"></td></tr>
                        <tr><td>เหตุการณ์ปัจจุบัน</td><td class="text-end" id="res-current"></td></tr>
                        <tr><td>การใช้เหตุผลและตรรกศาสตร์</td><td class="text-end" id="res-logic"></td></tr>
                        <tr class="table-primary fw-bold"><td>รวมความถนัด</td><td class="text-end" id="res-total-aptitude"></td></tr>
                    </table>
                </div>

                <div class="score-section bg-light">
                    <table class="table table-borderless mb-0">
                        <tr class="fs-5">
                            <td><strong>สอบสัมภาษณ์ (เต็ม 20):</strong></td>
                            <td class="text-end text-primary fw-bold" id="res-interview"></td>
                        </tr>
                        <tr class="fs-4 border-top">
                            <td><strong>คะแนนรวมทั้งสิ้น:</strong></td>
                            <td class="text-end text-success fw-bold" id="res-grand-total"></td>
                        </tr>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // *****************************************************************
    // นำ URL ที่ได้จากการ Deploy Apps Script (Web App) มาใส่ในเครื่องหมายคำพูดด้านล่าง
    const scriptUrl = 'https://script.google.com/macros/s/AKfycby4-u-QTtAtPHgB4qYIGg4hH1U5rDOCca5jkb6U5T3_RKEH8MZPhapqG_bd685UL5GR/exec'; 
    // *****************************************************************

    // ฟังก์ชันตรวจสอบรูปแบบเลขบัตรประชาชนไทย
    function checkThaiID(id) {
        if (id.length !== 13) return false;
        if (!/^[0-9]+$/.test(id)) return false; // ตรวจสอบว่าเป็นตัวเลขทั้งหมด

        let sum = 0;
        for (let i = 0; i < 12; i++) {
            sum += parseInt(id.charAt(i)) * (13 - i);
        }
        
        let checkDigit = (11 - (sum % 11)) % 10;
        return checkDigit === parseInt(id.charAt(12));
    }

    function searchData(event) {
        event.preventDefault();
        
        const idCard = document.getElementById('idCard').value;
        const btn = document.getElementById('searchBtn');
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('errorMsg');
        const resultArea = document.getElementById('resultArea');

        // ตรวจสอบความถูกต้องของเลขบัตรประชาชนก่อนส่งไป Backend
        if (!checkThaiID(idCard)) {
            errorMsg.innerText = 'รูปแบบเลขบัตรประจำตัวประชาชนไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง';
            errorMsg.style.display = 'block';
            resultArea.style.display = 'none';
            return; // หยุดการทำงาน ไม่ส่งรีเควสต์ไปเสียโควตา Apps Script
        }

        // Reset UI ถ้าเลขบัตรถูกต้อง
        btn.disabled = true;
        loading.style.display = 'block';
        errorMsg.style.display = 'none';
        resultArea.style.display = 'none';

        // ส่ง Request ไปยัง Apps Script
        fetch(scriptUrl + '?id=' + idCard, {
            method: 'GET',
            redirect: 'follow'
        })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                btn.disabled = false;

                if (data.status === 'success') {
                    // นำข้อมูลไปแสดงผล
                    const d = data.data;
                    document.getElementById('res-exam-no').innerText = d.exam_no;
                    document.getElementById('res-name').innerText = d.name;
                    document.getElementById('res-math').innerText = d.math;
                    document.getElementById('res-science').innerText = d.science;
                    document.getElementById('res-english').innerText = d.english;
                    document.getElementById('res-thai').innerText = d.thai;
                    document.getElementById('res-social').innerText = d.social;
                    document.getElementById('res-total-core').innerText = d.total_core;
                    
                    document.getElementById('res-law').innerText = d.law;
                    document.getElementById('res-politics').innerText = d.politics;
                    document.getElementById('res-current').innerText = d.current_events;
                    document.getElementById('res-logic').innerText = d.logic;
                    document.getElementById('res-total-aptitude').innerText = d.total_aptitude;
                    
                    document.getElementById('res-interview').innerText = d.interview;
                    document.getElementById('res-grand-total').innerText = d.grand_total;

                    resultArea.style.display = 'block'; // แสดงผล
                } else {
                    errorMsg.innerText = 'ไม่พบข้อมูลคะแนนสอบของเลขบัตรประชาชนนี้';
                    errorMsg.style.display = 'block'; // แสดงข้อผิดพลาด
                }
            })
            .catch(error => {
                console.error('Error!', error.message);
                loading.style.display = 'none';
                btn.disabled = false;
                errorMsg.innerText = 'เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์';
                errorMsg.style.display = 'block';
            });
    }
</script>
</body>
</html>

